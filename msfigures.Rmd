---
title: "msfigures"
author: "Jenny Rogers"
date: "June 2, 2020"
output: html_document
---


```{r}
library(tidyverse)
library(lubridate)
library(raster)
library(rasterVis)
library(sf)

```


manuscript figures
1. spatial maps future 2050 and 2100 RCP 8.5 and RCp 4.5 'normal' conditions and 2015
  - %inundation in the summer
  - Spartina height
  - probability of RR occurrence
  
2. Density plots
  - how drege and no dredge impact the results for  RCP8.5 2100
  - how el nino would impact the results for RCP8.5 2100

Tables:
1. summary stats for %inundation in summer, spartina height, probability of RR occurrence for baseline year 2015, and each scenario

Model results and validation:
1. zero inflated model results for spartina height using the training data in 2012
2. logistic regression results for Probability of LFRR occurrence using the 2011-2018 spartina height and % of 8 years that there was nesting within the extent that Karne did her survey
3. validation of probability of LRFF occurrence as predicted based on the delft3d 2015 spartina height and the 2015 rail survey
   -  make a prediction of >.5 an occurrence and see how many plots agreed with the 2015 georeferenced rail survey
   - R2 between the prob of occurrence and the percent of years occupied



Here we read in the future percent summer inundation values

```{r}

perc_summ_inund_fut <- raster::stack("C:/Users/JennyT/Documents/LitReview/UCI/working data/perc_summ_inund_fut.grd")
plot(perc_summ_inund_fut)
data.frame(cellStats(perc_summ_inund_fut, quantile))



png("summ_inund_fut.png", res = 300, width = 25, height = 15, units = "cm")
#plot all 8 combinations
print(rasterVis::levelplot(perc_summ_inund_fut, names.attr = c("2100_dre_RCP8_elnino", "2100_dre_RCP8_normal", 
                                                            "2100_dre_RCP4_elnino", "2100_dre_RCP4_normal", 
                                                            "2100_ND_RCP8_elnino", "2100_ND_RCP8_normal",
                                                            "2100_ND_RCP4_elnino", "2100_ND_RCP4_normal",
                                                            "2050_dre_RCP8_elnino", "2050_dre_RCP8_normal", 
                                                            "2050_dre_RCP4_elnino", "2050_dre_RCP4_normal", 
                                                            "2050_ND_RCP8_elnino", "2050_ND_RCP8_normal",
                                                            "2050_ND_RCP4_elnino", "2050_ND_RCP4_normal"),
                           scales=list(draw=FALSE),
                           layout=c(4, 4)))#remove axis ticks
dev.off()

densityplot(perc_summ_inund_fut)
bwplot(perc_summ_inund_fut)

```


Here we read in the future spartina heights
```{r}
sp_max_stack_fut <- raster::stack("C:/Users/JennyT/Documents/LitReview/UCI/working data/sp_max_stack_fut.grd")

plot(sp_max_stack_fut)

```

here we read in the future rail predictions and the 2015 rail predictions for validations. There are 16 scenarios total. First we determine if el nino or normal makes a difference, and if not we average predictions from the two and reduce it to 8 predictions.  
```{r}
#UNB shapefile
UNB <- st_read("C:/Users/JennyT/Documents/LitReview/UCI/working data/FinalData/UNB_Grid.shp")

#2015
load("C:/Users/JennyT/Documents/LitReview/UCI/working data/FinalData/bird_dat_inundation_2015_Delft3D_4.RData")
names(bird_dat_inundation_2015_Delft3D_4)[5] <- "railprob2015"
ggplot(data = bird_dat_inundation_2015_Delft3D_4, aes(fill = railprob2015))+
  geom_sf(color = NA)+
  labs(title = "Rail Probablity")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

#future
load("C:/Users/JennyT/Documents/LitReview/UCI/working data/FinalData/railpred.RData")

#does the year type (el nino vs normal) make a difference
t.test(railpred$predict[railpred$yrtype=="elnino"], railpred$predict[railpred$yrtype =="normal"])
#p-value = 0.3326, ie there is no evidence that the means between the two groups differ

#average the two year types together to reduce the number of scenarios
railpred <- railpred %>% 
  data.frame() %>% 
  dplyr::select(-SPSP_MAX_grt90, -SPSP_MAX_95, -SPSP_MAX_grt60, -geometry) %>% 
  pivot_wider(names_from = yrtype, values_from = predict) %>% 
  mutate(railprob = (normal+elnino)/2) %>% 
  dplyr::select(-elnino, -normal)
railpred <- left_join(UNB, railpred, by = "UID") %>% 
  filter(!is.na(year))
  
#plot the probability of rail occurrence
d <- ggplot(data = railpred, aes(fill = railprob))+
  geom_sf(color = NA)+
  labs(title = "Rail Probablity")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())+
  facet_grid(rows=vars(year), cols=vars(RCP, sediment))


ggsave(d, filename = "railProbFut.TIFF", dpi = 300, width = 25, height = 15, units = "cm", compression = "lzw")

```


In this chunk of code, we determine the average change in probablilty from 2015 for each of the scenarios

```{r}

baseline <- bird_dat_inundation_2015_Delft3D_4 %>% 
  data.frame() %>% 
  dplyr::select(UID, railprob2015, pct_rail_pres)

chng <- left_join(railpred, baseline, by = "UID") %>% 
  mutate(change = railprob - railprob2015)

ggplot(data = chng, aes(fill = change))+
  geom_sf(color = NA)+
  labs(title = "Rail Probablity")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())+
  facet_grid(rows=vars(year), cols=vars(RCP, sediment))


summary <- chng %>% 
  group_by(year, RCP, sediment) %>% 
  summarise(mean = mean(change, na.rm = TRUE),
            firstquartile = quantile(change, probs = 0.25, na.rm = TRUE),
            thirdQualtile = quantile(change, probs = 0.75, na.rm = TRUE))

```